---
author: willis
date: 2019-08-25 20:26
---
## Classloader 学习

### 类加载生命周期

![]({{ site.baseurl }}/images/2019-08-11/classloader-1.jpg)

其中，加载、验证、准备、初始化、卸载这个五个阶段顺序是固定的，类加载过程必须按照这种顺序按部就班的开始。

解析阶段不一定，他在某些情况可以再初始化阶段之后再开始，这是为了支持java语言运行时绑定。

### 初始化立即触发的情况

- new、getstatic、putstatic、或invokestatic时，如果类没有进行初始化，需要触发初始化
- 使用java.lang.reflect包的方法对类进行反射调用的时候，如果类没有初始化，需要先触发初始化
- 初始化一个类的时候，如果父类还未初始化，需要先出法父类初始化
- 虚拟机启动时，主类需要先初始化
- 动态语言支持是，入股偶一个java.lang.invoke,MethodHandle实例最后解析结果REF_getStatic、REF_pusStatic、REF_InvokeStatic的方法句柄，并且这个句柄所对应的的类

没有进行初始化，需要先触发它的初始化。



**这5中场景中的行为成为对一个类进行主动引用。**

**所有引用类的方式不都触发初始化，成为被动引用。**

### 类加载过程
#### 加载

记载阶段，虚拟机需要完成以下步骤

**1）通过类的全限定名获取定义此类的二进制字节流**

**2）将这个字节流所代表的的静态存储结构转化为方法区的运行时数据结构**

**3）在内存生成一个代表这个类的java.lang.Class 对象，作为方法区这个类的各种数据的访问入口**

**数组类与非数组类加载的过程**
非数组类，既可以使用系统提供的引导类加载器加载，又可以用用户自定义的类加载器加载。
数组类，由java虚拟机直接创建。但数组类的元素类型是（数组去掉所有维度的类型）靠类加载器去创建的。


#### 验证
连接的第一步，确保class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

**1）文件格式验证**

**2）元数据验证**

**3）字节码验证**

**4）符号引用验证**

#### 准备
正式为类变量分配内存并设置类变量初始值，这些变量所使用的内存都将在方法去中进行分配。

**注意两点：**

1）不包括实例变量。

2）准备阶段，初始化值指的是数据类型的零值。如：public static int value = 123;变量value在准备阶段过后的初始值为0而不是123。把value赋值为123的putstatic指令是程序呗编译后，存放于类构造器"&lt;clinit&gt;()"方法之中，所以把value赋值为123的动作将在初始化阶段才会执行。但如果字段的属性表中存在ConstantValue属性，那在准备阶段变量value就会被初始化为123.如public static final int value = 123

####  解析
虚拟机将常量池内的符号引用替换为直接引用的过程。

#### 初始化
类加载过程的最后一步，真正开始执行类中定义的java程序代码。
在初始化阶段，根据程序员通过程序制定的主观计划去初始化类变量和其他资源，或者可以从另一个角度来表达：初始化时执行类构造器"&lt;clinit&gt;()"方法的过程。

- &lt;clinit&gt;()方法是有编译器自动收集类中所有变量的赋值动作和静态语句块（static{}块）中的语句合并产生的。
- &lt;clinit&gt;()方法与实例构造器"&lt;init&gt;()"方法不同，他不需要显示的调用父类构造器，虚拟机会保证父类的clinit方法先被执行。

    &lt;clinit&gt;()是对类变量或静态块初始化。
    &lt;init&gt;()是对实例初始化，包括对非静态字段的初始化等操作。

- &lt;clinit&gt;()方法对于类或接口来说并不是必需的，果一个类中没有静态语句块，也没有对变量的赋值操作，那么编译器可以不为这个类生成&lt;clinit&gt;()方法。
- 接口中不能使用静态语句块，但仍可以有静态变量赋值操作，因此接口也会生成&lt;clinit&gt;()方法。但执行接口的&lt;clinit&gt;()方法不需要先执行父类的&lt;clinit&gt;()方法，只有当父类中定义的变量使用时，父接口才会初始化。另外，接口的实现类在初始化时也一样不会执行接口的&lt;clinit&gt;()方法。
- 虚拟机会保证一个类&lt;clinit&gt;()方法在多线程环境中被正确的加锁，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的&lt;clinit&gt;()方法。

